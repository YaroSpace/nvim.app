services: 
  database:
    image: postgres:latest
    ports:
      - '5432:5432'
    environment: 
      POSTGRES_USER: nvim
      POSTGRES_PASSWORD: nvim
      POSTGRES_DB: nvim.app
      POSTGRES_INITDB_ARGS: --encoding=UTF-8
    volumes:
      - db-data:/var/lib/postgresql/data
    container_name: nvim-app-database

  web:
    build: .
    depends_on:
      - database
    ports:
      - "9080:9080"
      - "127.0.0.1:7000:7000"
    environment:
      NVIM_APP_HOST: 0.0.0.0
      NVIM_APP_PORT: 9080
      NVIM_APP_REPL_PORT: 7000
      DATABASE_URL: jdbc:postgresql://database:5432/nvim.app
      DATABASE_USER: nvim
      DATABASE_PASSWORD: nvim
      # LOGBACK_LOGLEVEL: WARN
    container_name: nvim-app
    networks:
        coolify:
            aliases:
                - nvim-app
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:9080"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 10s
    labels:
      - traefik.enable=true
      - traefik.http.services.web.loadbalancer.server.port=9080
      # - traefik.http.routers.http-nvim-app-web.entryPoints=https
      # - "traefik.http.routers.http-nvim-app-web.rule=Host(`nvim.app`) && PathPrefix(`/`)"
      # - "traefik.http.routers.http-nvim-app-web.rule=Host(`www.nvim.app`) && PathPrefix(`/`)"

volumes:
  db-data:

networks:
    coolify:
        external: true
        name: coolify
        attachable: true
